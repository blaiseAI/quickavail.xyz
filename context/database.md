# QuickAvail MongoDB Database Schema

## Connection Details
```
mongodb://root:E86VJJ9tL7Kf99T87zt9qE60PDECpOxQlLFxZwJ74pr4t0YxaZGTIk1PBEkzp9Zv@5.78.79.33:27018/?directConnection=true
```

## Database: `quickavail`

## Collections

### 1. `availability_schedules`
**Purpose**: Store complete availability schedules that can be shared via links

```javascript
{
  _id: ObjectId,
  shareId: "abc123def456", // Unique ID for shareable links (generated by app)
  
  // User Information (for anonymous users OR linked to Clerk)
  clerkUserId: "user_2abc123def456ghi789", // Optional: null for anonymous users
  personName: "John Doe",
  personEmail: "john@example.com",
  
  // Selected Project
  selectedProject: "general", // Project ID
  
  // Projects Configuration
  projects: [
    {
      id: "general",
      name: "General",
      color: "bg-blue-500"
    },
    {
      id: "client",
      name: "Client Meetings", 
      color: "bg-green-500"
    }
  ],
  
  // Availability Data Structure
  selectedDates: {
    "general": {
      "2025-06-25": {
        quickSlots: ["morning", "afternoon"], // Array of: morning, afternoon, evening
        customSlots: [
          {
            id: "1234567890-abc123def",
            startTime: "09:00",
            endTime: "17:00",
            display: "9:00 AM - 5:00 PM"
          }
        ]
      },
      "2025-06-26": {
        quickSlots: ["evening"],
        customSlots: []
      }
    },
    "client": {
      "2025-06-27": {
        quickSlots: [],
        customSlots: [
          {
            id: "1234567891-def456ghi",
            startTime: "14:00", 
            endTime: "16:00",
            display: "2:00 PM - 4:00 PM"
          }
        ]
      }
    }
  },
  
  // Metadata
  createdAt: ISODate("2025-01-15T10:30:00Z"),
  expiresAt: ISODate("2025-01-22T10:30:00Z"), // 7 days from creation
  viewCount: 0, // Track how many times the link was accessed
  lastViewedAt: ISODate("2025-01-15T10:30:00Z"),
  
  // Optional: Analytics
  analytics: {
    totalHours: 11.5,
    daysSelected: 3,
    projectsUsed: ["general", "client"]
  }
}
```

**Indexes**:
```javascript
// Primary sharing lookup
db.availability_schedules.createIndex({ "shareId": 1 }, { unique: true })

// Cleanup expired schedules
db.availability_schedules.createIndex({ "expiresAt": 1 }, { expireAfterSeconds: 0 })

// Query by user (anonymous or Clerk users)
db.availability_schedules.createIndex({ "personEmail": 1, "createdAt": -1 })
db.availability_schedules.createIndex({ "clerkUserId": 1, "createdAt": -1 })
```

### 2. `quick_time_slots` (Optional - could be hardcoded)
**Purpose**: Store predefined time slot templates

```javascript
{
  _id: ObjectId,
  id: "morning",
  label: "Morning", 
  time: "9:00 AM - 12:00 PM",
  startTime: "09:00",
  endTime: "12:00",
  durationHours: 3,
  active: true
}
```

### 3. `users` (Future Enhancement - Clerk Integration)
**Purpose**: Store user profiles and preferences (linked to Clerk authentication)

```javascript
{
  _id: ObjectId,
  clerkUserId: "user_2abc123def456ghi789", // Clerk user ID (primary key)
  
  // User info from Clerk (synced)
  email: "john@example.com",
  firstName: "John",
  lastName: "Doe",
  profileImageUrl: "https://img.clerk.com/...",
  
  // QuickAvail-specific preferences
  preferences: {
    defaultProject: "general",
    timezone: "America/Denver", // Can get from Clerk or ask user
    defaultTimeSlots: ["morning", "afternoon"],
    emailNotifications: true,
    publicProfile: false // Allow others to find their schedules
  },
  
  // Custom projects (beyond default ones)
  customProjects: [
    {
      id: "custom-project-1",
      name: "Consulting",
      color: "bg-purple-500",
      description: "Client consulting sessions"
    }
  ],
  
  // QuickAvail-specific metadata
  createdAt: ISODate("2025-01-15T10:30:00Z"),
  lastActiveAt: ISODate("2025-01-15T10:30:00Z"),
  scheduleCount: 5, // Number of schedules created
  totalViews: 125, // Total views across all their schedules
  
  // Subscription info (if needed later)
  subscription: {
    plan: "free", // free, pro, enterprise
    scheduleLimit: 5,
    customProjectLimit: 3
  }
}
```

**Indexes for Clerk Integration**:
```javascript
// Primary lookup by Clerk user ID
db.users.createIndex({ "clerkUserId": 1 }, { unique: true })

// Email lookup (backup)
db.users.createIndex({ "email": 1 })

// Active users
db.users.createIndex({ "lastActiveAt": -1 })
```

### 4. `analytics` (Future Enhancement)
**Purpose**: Track usage and popular time slots

```javascript
{
  _id: ObjectId,
  date: ISODate("2025-01-15T00:00:00Z"),
  
  metrics: {
    schedulesCreated: 25,
    linksShared: 20,
    totalViews: 150,
    popularTimeSlots: {
      "morning": 15,
      "afternoon": 18, 
      "evening": 8
    },
    averageHoursPerSchedule: 8.5
  }
}
```

## API Endpoints Needed

### 1. Create/Save Schedule
```
POST /api/schedules
Body: {
  personName, personEmail, selectedProject, 
  projects, selectedDates
}
Response: { shareId, shareUrl, expiresAt }
```

### 2. Get Schedule by Share ID
```
GET /api/schedules/:shareId
Response: { schedule data } or 404/expired
```

### 3. Update View Count
```
POST /api/schedules/:shareId/view
Response: { success: true }
```

## Database Setup Scripts

### Initialize Database
```javascript
use quickavail;

// Create collections with validation
db.createCollection("availability_schedules", {
  validator: {
    $jsonSchema: {
      bsonType: "object",
      required: ["shareId", "personName", "personEmail", "selectedDates", "createdAt", "expiresAt"],
      properties: {
        shareId: { bsonType: "string", minLength: 10 },
        personName: { bsonType: "string", minLength: 1 },
        personEmail: { bsonType: "string", pattern: "^.+@.+\..+$" },
        selectedDates: { bsonType: "object" },
        createdAt: { bsonType: "date" },
        expiresAt: { bsonType: "date" }
      }
    }
  }
});

// Default quick time slots
db.quick_time_slots.insertMany([
  { id: "morning", label: "Morning", time: "9:00 AM - 12:00 PM", startTime: "09:00", endTime: "12:00", durationHours: 3 },
  { id: "afternoon", label: "Afternoon", time: "12:00 PM - 5:00 PM", startTime: "12:00", endTime: "17:00", durationHours: 5 },
  { id: "evening", label: "Evening", time: "5:00 PM - 8:00 PM", startTime: "17:00", endTime: "20:00", durationHours: 3 }
]);
```

## Implementation Priority

### Phase 1: Core Sharing (Immediate)
1. `availability_schedules` collection
2. Save schedule on "Generate Link" 
3. Retrieve schedule for shared links
4. Auto-expire after 7 days

### Phase 2: Analytics (Week 2)
1. View tracking
2. Basic usage metrics
3. Popular time slots analysis

### Phase 3: Clerk User Integration (Future)
1. Clerk authentication setup
2. Link schedules to Clerk user accounts
3. User preferences and custom projects
4. Schedule management dashboard
5. User profile pages

## Security Considerations

1. **Share IDs**: Use cryptographically secure random generation
2. **Rate Limiting**: Limit schedule creation per IP/user
3. **Data Validation**: Validate all inputs before saving
4. **Expiration**: Automatic cleanup of expired schedules
5. **Email Privacy**: Consider hashing emails for privacy
6. **Clerk Integration**: Leverage Clerk's built-in security features
   - Authentication handled by Clerk
   - User session management
   - Multi-factor authentication support
   - OAuth providers (Google, GitHub, etc.)

## Performance Optimizations

1. **Indexes**: On shareId (unique), expiresAt (TTL), personEmail
2. **Connection Pooling**: Configure MongoDB connection pool
3. **Caching**: Cache frequently accessed shared schedules
4. **Compression**: Enable MongoDB compression for storage efficiency
